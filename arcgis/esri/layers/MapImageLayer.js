// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/accessorSupport/decorators dojo/_base/lang dojo/io-query dojo/Deferred ../core/urlUtils ../core/promiseUtils ../config ../request ./DynamicLayer ./mixins/ArcGISDynamicMapService ./mixins/OperationalLayer ./mixins/PortalLayer".split(" "),function(w,x,m,e,d,g,n,p,h,q,r,k,s,t,u,v){return function(l){function b(a,f){l.call(this);this.alwaysRefetch=!1;this.legendEnabled=!0;this.operationalLayerType=
"ArcGISMapServiceLayer"}m(b,l);b.prototype.normalizeCtorArgs=function(a,f){return"string"===typeof a?g.mixin({url:a},f):a};b.prototype.load=function(){var a=this;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Map Service"]}).then(function(){return a._fetchService()}));return this};b.prototype.readLegendEnabled=function(a,f){return null!=f.showLegend?f.showLegend:!0};b.prototype.writeLegendEnabled=function(a,f){a||(f.showLegend=!1)};b.prototype.getImageUrl=function(a,f){var c=this,
b=this.parsedUrl.path+"/export",d=g.mixin({},this.parsedUrl.query,this.createExportImageParameters(a),{f:"image",token:this.token,_ts:this.alwaysRefetch?(new Date).getTime():null}),e=h.addProxy(b+"?"+n.objectToQuery(d));e.length>r.request.maxUrlLength?(d.f="json",k(b,{query:d,responseType:"json",callbackParamName:"callback"}).then(function(a){return h.addProxy(a.data.href+"?token\x3d"+c.token)}).then(f)):f(e)};b.prototype.fetchImage=function(a){var b=!1,c,d=new p(function(){b=!0;c&&(c=c.onload=c.onerror=
c.onabort=null)});10.3>this.version&&delete a.rotation;this.getImageUrl(a,function(e){b||(c=document.createElement("img"),c.setAttribute("alt",""),c.setAttribute("width",a.width.toString()),c.setAttribute("height",a.height.toString()),c.onload=function(b){c.onload=c.onerror=c.onabort=null;d.resolve({options:a,img:c});c=null},c.onerror=c.onabort=function(a){c.onload=c.onerror=c.onabort=null;d.reject(Error("Unable to load image: "+c.src));c=null},c.src=e)});return d.promise};b.prototype._fetchService=
function(){var a=this;return q.resolve().then(function(){return a.resourceInfo?{ssl:!1,data:a.resourceInfo}:k(a.parsedUrl.path,{query:g.mixin({f:"json"},a.parsedUrl.query),responseType:"json",callbackParamName:"callback"})}).then(function(b){b.ssl&&(a.url=a.url.replace(/^http:/i,"https:"));a.read(b.data,{origin:"service",url:a.parsedUrl})})};e([d.property()],b.prototype,"alwaysRefetch",void 0);e([d.property({type:Boolean})],b.prototype,"legendEnabled",void 0);e([d.read("legendEnabled",["showLegend"])],
b.prototype,"readLegendEnabled",null);e([d.write("legendEnabled")],b.prototype,"writeLegendEnabled",null);e([d.property()],b.prototype,"operationalLayerType",void 0);return b=e([d.subclass("esri.layers.MapImageLayer")],b)}(d.declared(s,t,u,v))});