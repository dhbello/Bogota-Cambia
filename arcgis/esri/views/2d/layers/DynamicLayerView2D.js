// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.
//>>built
define("../../../geometry/Extent ../../../core/HandleRegistry ../../../layers/support/ExportImageParameters ../engine/Bitmap ../viewpointUtils ./LayerView2D".split(" "),function(f,g,h,k,e,l){return l.createSubclass({declaredClass:"esri.views.2d.layers.DynamicLayerView2D",constructor:function(b){this._update=this._update.bind(this);this._hdls=new g;this._hdls.add(this.watch("view.state.version,view.stationary,suspended",this._update))},destroy:function(){this._hdls.destroy();this._hdls=null;this._exportImageParameters&&
(this._exportImageParameters.layer=null,this._exportImageParameters.destroy(),this._exportImageParameters=null)},getPopupData:function(b){var c=this.view.scale;return this.layer.allSublayers.filter(function(a){var d=0===a.minScale||c<=a.minScale,b=0===a.maxScale||c>=a.maxScale;return a.popupTemplate&&a.visible&&d&&b}).map(function(a){var d=a.createQuery();d.geometry=b;d.outFields=this.getTemplateOutFields(a.popupTemplate);return a.queryFeatures(d).then(function(a){return a.features})},this)},getTemplateOutFields:function(b){if(!b||
!b.fieldInfos)return["*"];var c=[];b.fieldInfos.forEach(function(a){var d=a.fieldName&&a.fieldName.toLowerCase();d&&("shape"!==d&&0!==d.indexOf("relationships/"))&&c.push(a.fieldName)});return c},_update:function(){if(this.view.stationary&&!this.suspended){var b=this.view.state,c=this.layer,a=b.size.concat();this._imagePromise&&(this._imagePromise.cancel(),this._imagePromise=null);10.3>c.version&&e.getOuterSize(a,b.viewpoint,a);a[0]=Math.min(a[0],c.maxImageWidth||2048);a[1]=Math.min(a[1],c.maxImageHeight||
2048);this.updating=!0;this._exportImageParameters?this._exportImageParameters.scale!==b.scale&&(this._exportImageParameters.scale=b.scale):(this._exportImageParameters=new h({layer:this.layer,scale:b.scale}),this._hdls.add(this._exportImageParameters.watch("version",function(a){this._imageVersion!==a&&(this._imageVersion=a,this._update())}.bind(this))));this._imageVersion=this._exportImageParameters.version;this._imagePromise=c.fetchImage({extent:e.getExtent(new f,b.viewpoint,a),width:a[0],height:a[1],
rotation:b.rotation,exportImageParameters:this._exportImageParameters});this._imagePromise.then(function(a){var b=a.options,c=this.container;this._imagePromise=null;this.view.stationary&&!this.suspended&&(c.removeAllChildren(),c.addChild(new k({coords:[b.extent.center.x,b.extent.center.y],resolution:b.extent.width/b.width,size:[0.5*b.width,0.5*b.height],source:a.img,rotation:-b.rotation})))}.bind(this),function(a){"cancel"!==a.dojoType&&(this.container.removeAllChildren(),this._imagePromise=null)}.bind(this)).always(function(){this.updating=
!1}.bind(this))}}})});