// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/views/3d/terrain/TerrainMaterial.xml":'\x3c?xml version\x3d"1.0" encoding\x3d"UTF-8"?\x3e\r\n\r\n\x3csnippets\x3e\r\n\r\n\x3csnippet name\x3d"vsTerrain"\x3e\x3c![CDATA[\r\n  precision mediump float;\r\n\r\n  uniform mat4 proj;\r\n  uniform mat4 view;\r\n  uniform vec3 origin;\r\n  uniform vec2 texOffset;\r\n  uniform float texScale;\r\n  uniform mat4 viewNormal;\r\n\r\n  attribute vec3 $position;\r\n  attribute vec2 $uv0;\r\n  varying vec2 vtc;\r\n  varying vec3 vpos;\r\n  varying vec3 vnormal;\r\n\r\n#if defined(WIREFRAME) || defined(TILE_BORDERS)\r\n  varying vec2 vuv;\r\n#endif\r\n\r\n#ifdef ATMOSPHERE\r\n  uniform vec3 lightDirection;\r\n  varying vec3 wpos;\r\n  varying vec3 wview;\r\n  varying vec3 wnormal;\r\n  varying vec3 wlight;\r\n#endif\r\n\r\n#ifdef OVERLAY\r\n  uniform vec2 overlayTexOffset;\r\n  uniform vec2 overlayTexScale;\r\n  varying vec2 vtcOverlay;\r\n#endif\r\n\r\n  void main(void) {\r\n    vpos \x3d $position;\r\n\r\n#ifdef SPHERICAL\r\n    vnormal \x3d normalize(vpos + origin);\r\n#else\r\n    vnormal \x3d vec3(0, 0, 1); // WARNING: up-axis dependent code\r\n#endif\r\n\r\n#ifdef ATMOSPHERE\r\n    wpos \x3d (view * vec4(vpos, 1.0)).xyz;\r\n    wnormal \x3d (viewNormal * vec4(normalize(vpos+origin), 1.0)).xyz;\r\n    wlight \x3d (view  * vec4(lightDirection, 1.0)).xyz;\r\n#endif\r\n\r\n#if defined(WIREFRAME) || defined(TILE_BORDERS)\r\n    vuv \x3d $uv0;\r\n#endif\r\n\r\n    gl_Position \x3d proj * view * vec4(vpos, 1.0);\r\n    vtc \x3d $uv0*texScale + texOffset;\r\n\r\n#ifdef OVERLAY\r\n    vtcOverlay \x3d $uv0*overlayTexScale + overlayTexOffset;\r\n#endif\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"fsTerrainCommon"\x3e\x3c![CDATA[\r\n  uniform vec3 lightDirection;\r\n  uniform vec3 viewDirection;\r\n  uniform sampler2D depthTex;\r\n  uniform int shadowMapNum;\r\n  uniform vec4 shadowMapDistance;\r\n  uniform mat4 shadowMapMatrix[4];\r\n  uniform float depthHalfPixelSz;\r\n  uniform sampler2D ssaoTex;\r\n  uniform vec4 viewportPixelSz;\r\n  uniform sampler2D tex;\r\n  uniform float opacity;\r\n\r\n  varying vec3 vpos;\r\n  varying vec3 vnormal;\r\n  varying vec2 vtc;\r\n\r\n#if defined(WIREFRAME) || defined(TILE_BORDERS)\r\n  varying vec2 vuv;\r\n#endif\r\n\r\n#ifdef ATMOSPHERE\r\n  varying vec3 wpos;\r\n  varying vec3 wview;\r\n  varying vec3 wnormal;\r\n  varying vec3 wlight;\r\n#endif\r\n\r\n  const vec3 ambient \x3d vec3(0.2,0.2,0.2);\r\n  const vec3 diffuse \x3d vec3(0.8,0.8,0.8);\r\n  const float diffuseHardness \x3d 2.5;\r\n\r\n#ifdef OVERLAY\r\n  uniform sampler2D overlayTex;\r\n  uniform float overlayOpacity;\r\n  varying vec2 vtcOverlay;\r\n#endif\r\n\r\n#ifdef RECEIVE_SHADOWS\r\n\t$evalShadow\r\n#endif\r\n\r\n  float lum(vec3 c) {\r\n    float max \x3d max(max(c.r, c.g), c.b);\r\n    float min \x3d min(min(c.r, c.g), c.b);\r\n    return (min + max) * 0.5;\r\n  }\r\n\r\n#ifdef ATMOSPHERE\r\n  vec3 atmosphere(vec3 lightPos, vec3 normal, vec3 view) {\r\n    vec3 surfaceColor   \x3d vec3(0.0);\r\n    vec3 fuzzySpecColor \x3d vec3(1.0);\r\n    vec3 subColor       \x3d vec3(0.0);\r\n    float rollOff       \x3d 1.0;\r\n\r\n    vec3 Ln \x3d normalize(lightPos);\r\n    vec3 Nn \x3d normalize(normal);\r\n    vec3 Hn \x3d normalize(view + Ln);\r\n\r\n    float ldn \x3d dot(Ln, Nn);\r\n    float diffComp \x3d max(0.0, ldn);\r\n    float vdn \x3d 1.0 - dot(view, Nn);\r\n    float ndv \x3d dot(view, Ln);\r\n\r\n    vec3 diffContrib \x3d surfaceColor * diffComp;\r\n    float subLamb \x3d max(0.0, smoothstep(-rollOff, 1.0, ldn) - smoothstep(0.0, 1.0, ldn));\r\n\r\n    vec3 subContrib \x3d subLamb * subColor;\r\n    vec3 vecColor \x3d vec3(vdn);\r\n\r\n    vec3 diffuseContrib \x3d (subContrib + diffContrib);\r\n    vec3 specularContrib \x3d (vecColor * fuzzySpecColor);\r\n\r\n    return (diffContrib + specularContrib) * rollOff;\r\n  }\r\n#endif\r\n\r\n  void main() {\r\n    vec3 a \x3d ambient;\r\n\r\n    float shadow \x3d 0.0;\r\n#ifdef RECEIVE_SHADOWS\r\n    shadow \x3d evalShadow(vpos, 1.0 / gl_FragCoord.w, depthTex, shadowMapNum, shadowMapDistance, shadowMapMatrix, depthHalfPixelSz);\r\n#endif\r\n    float vndl \x3d dot(normalize(vnormal), lightDirection);\r\n    float k \x3d smoothstep(0.0, 1.0, clamp(vndl*diffuseHardness, 0.0, 1.0));\r\n    vec3 d \x3d (1.0 - shadow/1.8) * diffuse * k;\r\n\r\n    float ssao \x3d viewportPixelSz.w \x3c .0 ? 1.0 : texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;\r\n    vec4 texVal \x3d texture2D(tex, vtc);\r\n    vec3 texCol \x3d texVal.rgb;\r\n    float texAlpha \x3d texVal.a;\r\n\r\n#ifdef OVERLAY\r\n    if ((vtcOverlay.x \x3e 0.0) \x26\x26 (vtcOverlay.y \x3e 0.0) \x26\x26 (vtcOverlay.x \x3c 1.0) \x26\x26 (vtcOverlay.y \x3c 1.0)) {\r\n      vec4 overlayTexCol \x3d texture2D(overlayTex, vtcOverlay);\r\n      overlayTexCol *\x3d overlayOpacity;\r\n      texCol \x3d texCol*(1.0-overlayTexCol.a) + overlayTexCol.rgb; // overlayTexCol has pre-multiplied alpha\r\n      texAlpha \x3d overlayTexCol.a + (1.0 - overlayTexCol.a) * texAlpha;\r\n    }\r\n#endif\r\n\r\n    vec3 atm \x3d vec3(0.0);\r\n#ifdef ATMOSPHERE\r\n    float ndotl \x3d max(0.0, min(1.0, vndl));\r\n    atm \x3d atmosphere(wlight, wnormal, -viewDirection);\r\n    atm *\x3d max(0.0, min(1.0, (1.0-lum(texCol)*1.5))); //avoid atmosphere on bright base maps\r\n    atm *\x3d max(0.0, min(1.0, ndotl*2.0)); // avoid atmosphere on dark side of the globe\r\n#endif\r\n    vec3 color \x3d atm + texCol * (a + d) * ssao;\r\n    gl_FragColor \x3d vec4(color, texAlpha * opacity);\r\n\r\n  // closing } is missing here, it\'s in the shaders using this snippet below\r\n\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"fsTerrainWireframe"\x3e\x3c![CDATA[\r\n#ifdef GL_OES_standard_derivatives\r\n#extension GL_OES_standard_derivatives : enable\r\n#endif\r\n\r\n  precision mediump float;\r\n\r\n  struct WireframeSettings {\r\n    float width;\r\n    float falloff;\r\n    float subdivision;\r\n    vec4 color;\r\n    float wireOpacity;\r\n    float surfaceOpacity;\r\n    float near;\r\n    float far;\r\n  };\r\n\r\n  uniform WireframeSettings wireframe;\r\n\r\n    $fsTerrainCommon\r\n\r\n    vec2 dVuv;\r\n    vec2 vuvScaled \x3d vuv * wireframe.subdivision;\r\n    vec2 vuvMod \x3d fract(vuvScaled);\r\n\r\n#ifdef GL_OES_standard_derivatives\r\n    dVuv \x3d fwidth(vuvScaled);\r\n#else\r\n    // Something that reasonably works\r\n    dVuv \x3d vec2(0.05);\r\n#endif\r\n\r\n    vec2 edgeFactors \x3d smoothstep((wireframe.width - wireframe.falloff) * dVuv,\r\n                                  wireframe.width * dVuv, min(vuvMod, 1.0 - vuvMod));\r\n\r\n    float edgeFactor \x3d 1.0 - min(edgeFactors.x, edgeFactors.y);\r\n\r\n#ifdef WIREFRAME\r\n    gl_FragColor \x3d vec4(mix(gl_FragColor.rgb, wireframe.color.rgb, edgeFactor * wireframe.color.a),\r\n                        mix(wireframe.surfaceOpacity, wireframe.wireOpacity, edgeFactor));\r\n#endif\r\n\r\n\r\n#ifdef TILE_BORDERS\r\n    dVuv \x3d fwidth(vuv);\r\n    edgeFactors \x3d smoothstep((wireframe.width - wireframe.falloff) * dVuv,\r\n                              wireframe.width * dVuv, min(vuv, 1.0 - vuv));\r\n    edgeFactor \x3d 1.0 - min(edgeFactors.x, edgeFactors.y);\r\n\r\n    gl_FragColor \x3d mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);\r\n#endif\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"fsTerrain"\x3e\x3c![CDATA[\r\n  precision mediump float;\r\n\r\n    $fsTerrainCommon\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"vsTerrainNormal"\x3e\x3c![CDATA[\r\n  uniform vec3 origin;\r\n  uniform mat4 proj;\r\n  uniform mat4 view;\r\n  uniform mat4 viewNormal;\r\n  attribute vec3 $position;\r\n  varying vec3 vnormal;\r\n\r\n  void main(void) {\r\n#ifdef SPHERICAL\r\n    vec4 normal \x3d vec4(normalize($position + origin), 1.0);\r\n#else\r\n    vec4 normal \x3d vec4(0.0, 1.0, 0.0, 1.0);\r\n#endif\r\n\r\n    gl_Position \x3d proj * view * vec4($position, 1.0);\r\n    vnormal \x3d normalize((viewNormal * normal).xyz);\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"vsTerrainDepthOnly"\x3e\x3c![CDATA[\r\n  precision mediump float;\r\n\r\n  uniform mat4 proj;\r\n  uniform mat4 view;\r\n\r\n  attribute vec3 $position;\r\n\r\n  void main() {\r\n    gl_Position \x3d proj * view * vec4($position, 1.0);\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"fsTerrainDepthOnly"\x3e\x3c![CDATA[\r\n  precision mediump float;\r\n\r\n  void main() {\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3c/snippets\x3e\r\n'}});
define("dojo/Deferred dojo/when ./TileUtils ./TerrainConst ./TileGeometryFactory ../support/PreallocArray ../support/ObjectPool ../webgl-engine/lib/ShaderVariations dojo/text!./TerrainMaterial.xml ../webgl-engine/materials/internal/MaterialUtil ../webgl-engine/lib/Util ../lib/glMatrix ../webgl-engine/lib/RenderPass ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/tracer ../../webgl/Texture ../../webgl/FramebufferObject ../../webgl/VertexArrayObject ../../webgl/BufferObject ../../webgl/Program ../webgl-engine/lib/DefaultVertexAttributeLocations ../webgl-engine/lib/DefaultVertexBufferLayouts ../../webgl/Util".split(" "),
function(Pa,Qa,L,D,da,T,ra,sa,Ra,ea,y,E,M,U,fa,V,Sa,ta,ga,ua,W,va,X){var ha=y.assert,z=E.vec2d,k=E.vec3d,wa=E.vec4d,Ta=E.mat4d.identity(),Ua=[2,2],xa=U.OPAQUE_TERRAIN,ya=U.TRANSPARENT_TERRAIN,za=[0,0],Aa=k.create(),ia,ja=z.create(),Y=function(){this.overlayTexOffset=z.create();this.texOffset=z.create();this.geometryInfo={geometry:null,numSurfaceIndices:0,numSkirtIndices:0,numWithoutSkirtIndices:0,numVertsPerRow:0};this.init()};Y.prototype.init=function(){this.geometryInfo.geometry=null;this.geometryInfo.numSurfaceIndices=
0;this.geometryInfo.numSkirtIndices=0;this.geometryInfo.numWithoutSkirtIndices=0;this.geometryInfo.numVertsPerRow=0;this.textureReference=this.texture=this.vao=this.geometryState=null;z.set2(0,0,this.texOffset);this.texScale=1;this.overlayTexId=null;this.overlayTexScale=[1,1];this.overlayOpacity=1;this.localOrigin=null};Y.prototype.updateGeometryState=function(k){return this.geometryState=k.geometryState(this.geometryState)};y=function(y,F){function E(a,b){var c=a.screenDepth,d=b.screenDepth;return c<
d?-H:c>d?H:0}function U(a,b){return 0===a.tiles.length?-H:0===b.tiles.length?H:E(a.tiles.data[0],b.tiles.data[0])}function Z(a,b){void 0===b&&(b=f.subdivisionReduceLevels);return 0===b?a:0>b?Math.floor((a-1)*(1<<-b))+1:Math.floor((a-1)/(1<<b))+1}F=F||256;var Ba,Ca=!1,q=null,ka=null,n=null,Da={},e,h,Ea=new ra(100,Y),l=new T(10,function(){return{root:null,tiles:new T(300)}}),A=new L.IteratorPreorder,N,$,Fa,Ga,Ha=!0,I=1,la=!0,f={mode:"none",width:1.5,falloff:1.5,wireOpacity:1,surfaceOpacity:0,color:[1,
1,1,0],subdivision:"geometry",subdivisionReduceLevels:0},J=!1,Ia=!1,ma=!1,H=1,aa=!0,na=!0,w=null,B=null,K=null,O=null,P=null,Ja=null,G=[];this.updateTileBackground=function(a){P&&P.reject();Ja=a;var b=new Pa;P=b;if(a){var c=new Image;c.src=a instanceof Image?a.src:a;c.onload=function(){b.isFulfilled()||b.resolve(c)}}else b.resolve(null);this.renderTileBackground();return b.promise};var ba=0,Q=0,oa=0,pa=0;this.numTileTexturesComposited=0;this.castShadows=!1;this.loaded=function(){};var Ka=!1;this.needsRender=
!0;this.receiveShadows=this.didRender=!1;var x=new T(10),R=0,ca=new T(30),La=new ra(10,function(){this.extent=wa.create();this.maxLevel=this.minLevel=0;this.callback=null});this.renderTileBackground=function(){if(e&&P)return P.then(function(a){K=this._buildTexture(a);q&&L.traverseTilesPreorder(q,function(a){this.updateTileTexture(a)}.bind(this))}.bind(this))};this.initializeRenderContext=function(a){e=a.rctx;h=a.rctx.gl;$=e.extensions.textureFilterAnisotropic;ha(!ia||ia===$.TEXTURE_MAX_ANISOTROPY_EXT,
"contexts have different definitions afExt.TEXTURE_MAX_ANISOTROPY_EXT");null!=$&&(ia=$.TEXTURE_MAX_ANISOTROPY_EXT,Fa=e.parameters.maxMaxAnisotropy,Ga=Math.min(8,Fa));da.setSupportsUintIndices(!!e.extensions.elementIndexUint);Qa(this.renderTileBackground(),function(){Ca=!0;this.setNeedsRender()}.bind(this));var b=new Float32Array(20);b[0]=-1;b[1]=-1;b[2]=0;b[3]=0;b[4]=0;b[5]=1;b[6]=-1;b[7]=0;b[8]=1;b[9]=0;b[10]=-1;b[11]=1;b[12]=0;b[13]=0;b[14]=1;b[15]=1;b[16]=1;b[17]=0;b[18]=1;b[19]=1;B=new ta(e,W.Default3D,
{geometry:va.Pos3Tex},{geometry:ga.createVertex(e,h.STATIC_DRAW,b)});Ba=a.textureRep;var b=a.shaderSnippets,c=a.shaderRep;a=a.programRep;b.vsTerrain||b._parse(Ra);e.extensions.standardDerivatives;var d=new sa("terrain",["vsTerrain","fsTerrain"],null,a,c,b,e);d.addDefine("Spherical","SPHERICAL");d.addDefine("Overlay","OVERLAY");d.addDefine("Atmosphere","ATMOSPHERE");d.addDefine("Wireframe","WIREFRAME");d.addDefine("TileBorders","TILE_BORDERS");d.addBinaryShaderSnippetSuffix("Wireframe","Wireframe",
[!1,!0]);d.addDefine("ReceiveShadows","RECEIVE_SHADOWS");c=new sa("terrainNormal",["vsTerrainNormal","fsNormal"],null,a,c,b,e);c.addDefine("Spherical","SPHERICAL");c.addDefine("AlphaZero","ALPHA_ZERO");n={depth:a.get("depth"),depthShadowMap:a.get("depthShadowMap"),depthOnly:new ua(e,b.vsTerrainDepthOnly,b.fsTerrainDepthOnly,W.Default3D),blendLayers:new ua(e,b.vertexShaderBlendLayers,b.fragmentShaderBlendLayers,W.Default3D)};ka={color:d,normal:c};this._updatePrograms();O=new V(e,{target:h.TEXTURE_2D,
pixelFormat:h.RGBA,dataType:h.UNSIGNED_BYTE,samplingMode:h.NEAREST,width:4,height:4})};this.uninitializeRenderContext=function(a){null!=B&&(B.dispose(!0),B=null);null!=O&&(O.dispose(),O=null);null!=K&&(K.dispose(),K=null);null!=w&&(w.dispose(),w=null)};this._updatePrograms=function(){var a="spherical"===y,b="shader"===f.mode;n.color=ka.color.getProgram([a,!0,a&&na,b,J,b||J,this.receiveShadows]);n.normal=ka.normal.getProgram([a,!0])};this.install=function(a){a.addExternalRenderer([xa,ya],this)};this.uninstall=
function(a){a.removeExternalRenderer(this)};this.setRootTiles=function(a){q=a};this.isStencilEnabledLayerExtent=function(a){return G.some(function(b){return a===b.id})};this.addStencilEnabledLayerExtent=function(a,b){G.push({id:a,extent:[b[0],b[1],b[3],b[4]]})};this.removeStencilEnabledLayerExtent=function(a){for(var b=0;b<G.length;b++)if(a===G[b].id){G.splice(b,1);break}};this.setTileSize=function(a){F=a};this.loadTile=function(a){ha(null===a.renderData);a.renderData=Ea.acquire();a.renderData.init();
var b=this.getLocalOriginOfTile(a),c=a.createGeometry(a.renderData.updateGeometryState(a),b,"debug"===f.mode,a.renderData.geometryInfo);a.renderData.localOrigin=b;this._setTileGeometry(a,c);this.updateTileTexture(a)};this.queryVisibleLevelRange=function(a,b,c,d){var e=La.acquire();wa.set(a,e.extent);e.minLevel=b?b:-Number.MAX_VALUE;e.maxLevel=null!=c?c:Number.MAX_VALUE;e.callback=d;ca.push(e);this.setNeedsRender()};this._buildTexture=function(a){var b={target:h.TEXTURE_2D,pixelFormat:h.RGBA,dataType:h.UNSIGNED_BYTE,
wrapMode:h.CLAMP_TO_EDGE,samplingMode:h.LINEAR,maxAnisotropy:Ga,flipped:!0,hasMipmap:!0},c;if(a)try{c=new V(e,b,a)}catch(d){b.width=b.height=F,c=new V(e,b),console.warn("TerrainRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}else b.width=b.height=F,c=new V(e,b);e.bindTexture(c);c.generateMipmap();return c};this._composeTexture=function(a,b,c){e.bindTexture(a,0);n.blendLayers.setUniform1f("scale",b);n.blendLayers.setUniform2fv("offset",c);e.bindVAO(B);e.drawArrays(h.TRIANGLE_STRIP,
0,X.vertexCount(B,"geometry"))};this._composeMapLayers=function(a,b,c,d,r){var S=D.LayerClass.MAP;a.renderData.texture||(a.renderData.texture=this._buildTexture());var g=a.renderData.texture;null===w||w.width!==g.descriptor.width||w.height!==g.descriptor.height?w=Sa.createWithAttachments(e,g,{colorTarget:0,depthStencilTarget:0}):(w.detachColorTexture(),w.attachColorTexture(g));e.bindFramebuffer(w);e.setViewport(0,0,F,F);e.setClearColor(0,0,0,0);e.clear(h.COLOR_BUFFER_BIT);e.setBlendingEnabled(!0);
e.setBlendFunctionSeparate(h.ONE_MINUS_DST_ALPHA,h.DST_ALPHA,h.ONE_MINUS_DST_ALPHA,h.ONE);e.bindProgram(n.blendLayers);n.blendLayers.setUniform1i("tex",0);e.bindVAO(B);X.assertCompatibleVertexAttributeLocations(B,n.blendLayers);for(g=0;g<=c;g++){var f=b[g],t=null,C,v;f.data?(t=f,C=za,v=1):f.upsampleFromTile&&(v=f.upsampleFromTile,t=v.tile.layerInfo[S][g],C=v.offset,v=v.scale);t&&(t.data instanceof Image&&(t.data=this._buildTexture(t.data)),n.blendLayers.setUniform1f("opacity",r[g]),this._composeTexture(t.data,
v,C))}d&&this._composeTexture(K,1,za);e.bindTexture(a.renderData.texture);a.renderData.texture.generateMipmap();e.bindFramebuffer(null);e.setBlendFunctionSeparate(h.SRC_ALPHA,h.ONE_MINUS_SRC_ALPHA,h.ONE,h.ONE_MINUS_SRC_ALPHA);e.setBlendingEnabled(!1);this.numTileTexturesComposited++};var Ma=Array(20);this.updateTileTexture=function(a){for(var b=a.layerInfo[D.LayerClass.MAP],c=0;c<b.length;c++)b[c].pendingUpdates&=~D.TileUpdateTypes.UPDATE_TEXTURE;if(a.renderData){var d,e=D.LayerClass.MAP,c=a.renderData,
f,g=0;for(f=0;f<b.length;f++){d=b[f];var h=a.parentSurface.layerViewByIndex(f,e),t=h.fullOpacity;Ma[f]=t;if(d.data||d.upsampleFromTile)if(g++,!h.isTransparent()&&1<=t)break}d=!1;f===b.length&&(d=!0,f--);0===g?(c.textureReference=K,z.set2(0,0,c.texOffset),c.texScale=1):1===g&&!d?(d=b[f],d.data?(b=d,z.set2(0,0,c.texOffset),c.texScale=1):(a=d.upsampleFromTile,b=a.tile.layerInfo[e][f],z.set(a.offset,c.texOffset),c.texScale=a.scale),b&&(b.data instanceof Image&&(b.data=this._buildTexture(b.data)),c.textureReference=
b.data)):(this._composeMapLayers(a,b,f,d,Ma),c.textureReference=null,z.set2(0,0,c.texOffset),c.texScale=1);this.setNeedsRender()}};this.releaseTileTexture=function(a){a.dispose()};this.releaseTileTextures=function(a){a=a.layerInfo[D.LayerClass.MAP];for(var b=0;b<a.length;b++){var c=a[b];c&&c.data instanceof window.WebGLTexture&&c.data.dispose()}};this.updateTileGeometryNeedsUpdate=function(a){return a.renderData.updateGeometryState(a).needsUpdate};this._updateTileGeometry=function(a){for(var b=a.renderData.geometryState,
c=a.layerInfo[D.LayerClass.ELEVATION],d=0;d<c.length;d++)c[d].pendingUpdates&=~D.TileUpdateTypes.UPDATE_GEOMETRY;return b.needsUpdate?(a.renderData.vao&&this._releaseTileGeometry(a),b=a.createGeometry(b,a.renderData.localOrigin,"debug"===f.mode,a.renderData.geometryInfo),this._setTileGeometry(a,b),!0):!1};this.updateTileGeometry=function(a){a.renderData.updateGeometryState(a);return this._updateTileGeometry(a)};this.unloadTile=function(a){this._releaseTileGeometry(a);a.renderData.texture&&a.renderData.texture.dispose();
Ea.release(a.renderData);a.renderData=null};this.getLocalOriginOfTile=function(a){if(10<=a.lij[0]){for(;7<a.lij[0];)a=a.parent;return a.centerAtSeaLevel}if("spherical"===y)return Aa;for(;a.parent;)a=a.parent;return a.centerAtSeaLevel};this.setVisibility=function(a){Ha=a;this.setNeedsRender()};this.getStats=function(){return{numTilesRendered:Q,numTilesCulled:oa,numTrianglesRendered:ba,numOriginsRendered:pa}};this.setDisableRendering=function(a){Ia=!!a;this.setNeedsRender()};this.getOpacity=function(){return I};
this.getWireframeEnabled=function(){return"shader"===f.mode};this.setWireframe=function(a){if(!a||!0===a)a={mode:a?"shader":"none"};if(void 0!==a.mode&&f.mode!==a.mode){var b="debug"===f.mode,c="debug"===a.mode;f.mode=a.mode;this._updatePrograms();b!==c&&q&&L.traverseTilesPreorder(q,function(a){if(a.renderData){a.renderData.vao&&this._releaseTileGeometry(a);var b=a.createGeometry(a.renderData.updateGeometryState(a),a.renderData.localOrigin,c,a.renderData.geometryInfo);this._setTileGeometry(a,b)}}.bind(this));
this.setNeedsRender()}for(var d in a)f.hasOwnProperty(d)&&(f[d]=a[d]),this.setNeedsRender()};this.setOpacity=function(a){I=a;this.setNeedsRender()};this.setDrawSkirts=function(a){la=a;this.setNeedsRender()};this.setCullBackFaces=function(a){ma=a;this.setNeedsRender()};this.setRenderOrder=function(a){H=a;this.setNeedsRender()};this.setBorders=function(a){J!==a&&(J=a,"none"===f.mode&&(f.transitionTime=0),this._updatePrograms(),this.setNeedsRender())};this.setFrontMostTransparent=function(a){aa!==a&&
(aa=a,this.setNeedsRender())};this.setVelvetOverground=function(a){na!==a&&(na=a,this._updatePrograms(),this.setNeedsRender())};this.setNeedsRender=function(){this.needsRender=!0;this.didRender=!1};this.resetNeedsRender=function(){this.didRender&&(this.needsRender=0!==ca.length,this.didRender=!1)};var qa=k.create();this.isTransparent=function(){return 1>I||"shader"===f.mode&&(1>f.wireOpacity||1>f.surfaceOpacity)||!Ja};this.render=function(a){if(Ca&&!Ia&&Ha&&q){var b=this.isTransparent();if(a.slot===
(b?ya:xa)){fa.trace("# BEGIN RENDER TERRAIN");l.clear();N=null;this._renderCollectOrigins();if(0!==H){for(var c=0;c<l.length;c++)this._sortFrontToBack(l.data[c].tiles,E);this._sortFrontToBack(l,U)}var d,r=!1,S=!1;d=a.pass;var g=a.camera;e.setBlendFunctionSeparate(h.SRC_ALPHA,h.ONE_MINUS_SRC_ALPHA,h.ONE,h.ONE_MINUS_SRC_ALPHA);e.setFaceCullingEnabled(ma);if(d===M.MATERIAL){if(S=b,r=a.shadowMap&&a.shadowMap.getEnableState(),this.receiveShadows!=r&&(this.receiveShadows=r,this._updatePrograms()),b&&aa&&
(r=n.depthOnly,e.bindProgram(r),e.setColorMask(!1,!1,!1,!1),e.setDepthTestEnabled(!0),this._renderTilesDepthOnly(g,e,r),e.setColorMask(!0,!0,!0,!0),e.setDepthFunction(h.EQUAL),e.setDepthWriteEnabled(!1)),d=n.color,r=!0,e.bindProgram(d),d.setUniform1f("opacity",I),e.setBlendingEnabled(S),"shader"===f.mode||J)d.setUniform1f("wireframe.width",f.width),d.setUniform1f("wireframe.falloff",Math.min(f.width,f.falloff)),d.setUniform1f("wireframe.wireOpacity",f.wireOpacity*I),d.setUniform1f("wireframe.surfaceOpacity",
f.surfaceOpacity*I),d.setUniform4fv("wireframe.color",f.color),d.setUniform1f("wireframe.near",g.near),d.setUniform1f("wireframe.far",g.far),"geometry"!==f.subdivision&&"constant"!==f.subdivision&&d.setUniform1f("wireframe.subdivision",Z(f.subdivision))}else if(d===M.MATERIAL_DEPTH_SHADOWMAP&&this.castShadows||d===M.MATERIAL_DEPTH)d=d===M.MATERIAL_DEPTH_SHADOWMAP?n.depthShadowMap:n.depth,e.bindProgram(d),d.setUniformMatrix4fv("model",Ta),ja[0]=g.near,ja[1]=g.far,d.setUniform2fv("nearFar",ja);else if(d===
M.MATERIAL_NORMAL)d=n.normal,e.bindProgram(d);else return;a.shadowMap&&a.shadowMap.bind(d);a.ssaoHelper&&a.ssaoHelper.setUniforms(d);r&&(d.setUniform1i("tex",4),d.setUniform1i("overlayTex",5));d.setUniformMatrix4fv("viewNormal",g.viewInverseTransposeMatrix);d.setUniformMatrix4fv("proj",g.projectionMatrix);d.setUniform3fv("lightDirection",a.lightingData.direction);g=g.viewMatrix;k.set3(g[12],g[13],g[14],qa);k.normalize(qa);d.setUniform3fv("viewDirection",qa);for(pa=ba=oa=Q=0;x.length<x.data.length&&
0<ca.length;)c=ca.pop(),x.push(c);R=x.length;for(c=0;c<l.length;c++){var s=l.data[c];d.setUniform3fv("origin",s.origin);ea.bindView(s.origin,g,d);a.shadowMap&&a.shadowMap.bindView(d,s.origin);pa++;this._renderTiles(s.tiles,d,r,a)}S&&e.setBlendingEnabled(!1);b&&aa&&(e.setDepthFunction(h.LESS),e.setDepthWriteEnabled(!0));ma&&e.setFaceCullingEnabled(!1);a.stencilRenderingHelper&&a.stencilRenderingHelper.getEnableState()&&a.stencilRenderingHelper.prepareStencilDisabledPass();for(a=0;a<x.length;a++)b=
x.data[a],La.release(b),b.callback(a>=R),b.callback=null;x.clear();0<Q&&!Ka&&(Ka=!0,this.loaded&&this.loaded());fa.trace("# END RENDER TERRAIN");return!0}}};this._renderCollectOrigins=function(){for(var a=0;a<q.length;a++){var b=q[a],c=l.next();c.root=b;c.origin="spherical"===y?Aa:b.centerAtSeaLevel;c.tiles.clear();this._renderCollectOriginsForRoot(c)}};this._renderCollectOriginsForRoot=function(a){for(A.reset(a.root);!A.done;){var b=A.next(),c=b.renderData;if(c&&!b.visible)oa++,A.skip();else{var d=
l.peek();if(7===b.lij[0]){if(d===a||0!==d.tiles.length)d=l.next(),d.tiles.clear();d.root=b;d.origin=b.centerAtSeaLevel}if(c){c=b.lij[0];10<=c?l.peek().tiles.push(b):a.tiles.push(b);if(null===N||N.lij[0]<c)N=b;A.skip()}}}};this._sortFrontToBack=function(a,b){a.sort(b)};this._renderTilesDepthOnly=function(a,b,c){var d=a.viewMatrix;c.setUniformMatrix4fv("proj",a.projectionMatrix);for(a=0;a<l.length;a++){var e=l.data[a];c.setUniform3fv("origin",e.origin);ea.bindView(e.origin,d,c);for(var f=0;f<e.tiles.length;f++){var g=
e.tiles.data[f].renderData;b.bindVAO(g.vao);X.assertCompatibleVertexAttributeLocations(g.vao,c);var s=g.vao.indexBuffer.size;la||(s=g.geometryInfo.numWithoutSkirtIndices);b.drawElements(h.TRIANGLES,s,g.vao.indexBuffer.indexType,0)}}b.bindVAO(null)};this._renderTiles=function(a,b,c,d){if(0!==a.length){var r=h.TRIANGLES;"debug"===f.mode&&(r=h.LINES);var n="geometry"===f.subdivision,g="constant"===f.subdivision,s=N,t,C=!1;s?(t=s.lij[0],s=Z(s.renderData.geometryInfo.numVertsPerRow)):s=t=16;e.setDepthTestEnabled(!0);
e.setBlendingEnabled(this.isTransparent());for(var v=0;v<a.length;v++){var u=a.data[v],p=u.renderData;if(d.stencilRenderingHelper&&d.stencilRenderingHelper.getEnableState()){for(var m=!1,k=0;k<G.length;k++)if(u.intersectsExtent(G[k].extent)){m=!0;break}m&&!C?(d.stencilRenderingHelper.prepareStencilReadPass(),C=!0):!m&&C&&(d.stencilRenderingHelper.prepareStencilDisabledPass(),C=!1)}fa.trace("# RENDER TILE "+u.lij[0]+"/"+u.lij[1]+"/"+u.lij[2]+", screenDepth:"+u.screenDepth);if(c){b.setUniform2fv("texOffset",
p.texOffset);b.setUniform1f("texScale",p.texScale);e.bindTexture(p.textureReference||p.texture,4);if(p.overlayTexId){var m=b,k=p,l=k.overlayTexId,q=Da[l];q||(q=Ba.aquire(l).getGLTexture(),ha(q),Da[l]=q);m.setUniform2fv("overlayTexOffset",k.overlayTexOffset);m.setUniform2fv("overlayTexScale",k.overlayTexScale);m.setUniform1f("overlayOpacity",k.overlayOpacity);e.bindTexture(q,5)}else b.setUniform2fv("overlayTexOffset",Ua),e.bindTexture(O,5);if(("shader"===f.mode||J)&&(n||g))n?b.setUniform1f("wireframe.subdivision",
Z(p.geometryInfo.numVertsPerRow)):(m=Z(s,u.lij[0]-t),b.setUniform1f("wireframe.subdivision",m))}m=p.vao.indexBuffer.size;la||(m=p.geometryInfo.numWithoutSkirtIndices);e.bindVAO(p.vao);X.assertCompatibleVertexAttributeLocations(p.vao,b);e.drawElements(r,m,p.vao.indexBuffer.indexType,0);u.renderOrder=Q;Q++;ba+=m/3;p=u.extent;u=u.lij[0];for(m=0;m<R;)k=x.data[m],l=k.extent,u>=k.minLevel&&u<=k.maxLevel&&l[0]<=p[2]&&l[2]>=p[0]&&l[1]<=p[3]&&l[3]>=p[1]?(x.swap(m,R-1),R--):m++}e.bindVAO(null)}};var Va=k.create(),
Na=k.create(),Oa=k.create();this.intersect=function(a,b,c,d){if(q&&!("select"===a.mode&&this.isTransparent())){k.subtract(c,b,Va);var e=a.getMinResult(),f=a.getMaxResult();for(A.reset(q);!A.done;){var g=A.next();if(null!==g.renderData){var h=g.renderData.geometryInfo.geometry,l=g.renderData.localOrigin;k.subtract(b,l,Na);k.subtract(c,l,Oa);ea.intersectTriangleGeometry(h,0,void 0,d,b,c,Na,Oa,void 0,a.tolerance,function(a,b){if(0<=a){var c;if(void 0===e.dist||a<e.dist)c=L.lij2str(g.lij[0],g.lij[1],
g.lij[2]),e.set(void 0,c,a,b,void 0),e.setIntersector("terrain");if(void 0===f.dist||a>f.dist)c=L.lij2str(g.lij[0],g.lij[1],g.lij[2]),f.set(void 0,c,a,b,void 0),f.setIntersector("terrain")}})}}}};this._setTileGeometry=function(a,b){var c=a.renderData,d=b.geometry.getData(),f=d.getVertexAttr().terrain.data,d=d.getFaces()[0].indices.terrain;c.vao=new ta(e,W.Default3D,{geometry:va.Pos3Tex},{geometry:ga.createVertex(e,h.STATIC_DRAW,f)},ga.createIndex(e,h.STATIC_DRAW,d));c.geometryInfo.geometry&&da.releaseGeometry(c.geometryInfo.geometry);
c.geometryInfo=b;this.setNeedsRender()};this._releaseTileGeometry=function(a){a=a.renderData;a.vao.dispose(!0);a.vao=null;a.geometryInfo.geometry&&da.releaseGeometry(a.geometryInfo.geometry);a.geometryInfo.geometry=null;this.setNeedsRender()}};y.TileRenderData=Y;return y});